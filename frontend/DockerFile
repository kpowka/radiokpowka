# Purpose: Build Vite React frontend and serve via nginx.

FROM node:20 AS build
WORKDIR /app
COPY frontend/package.json frontend/package-lock.json* ./frontend/
WORKDIR /app/frontend
RUN npm ci
COPY frontend ./frontend

# IMPORTANT:
# VITE_* variables should be provided at build time for correct API endpoints
# Example:
# docker build --build-arg VITE_API_BASE=http://backend:8080 ...
ARG VITE_API_BASE
ARG VITE_WS_URL
ARG VITE_STREAM_URL
ENV VITE_API_BASE=$VITE_API_BASE
ENV VITE_WS_URL=$VITE_WS_URL
ENV VITE_STREAM_URL=$VITE_STREAM_URL

RUN npm run build

FROM nginx:stable-alpine
COPY --from=build /app/frontend/dist /usr/share/nginx/html

# Simple SPA routing
RUN printf '%s\n' \
'server {' \
'  listen 80;' \
'  server_name _;' \
'  root /usr/share/nginx/html;' \
'  index index.html;' \
'  location / {' \
'    try_files $uri $uri/ /index.html;' \
'  }' \
'}' > /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
